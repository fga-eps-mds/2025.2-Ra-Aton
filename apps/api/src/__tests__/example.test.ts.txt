import request from "supertest";
// Importamos o 'app' real, que usará o 'prisma' mockado
import app from "../app";
// Importamos o 'prisma' para ter uma referência ao mock e controlar seu comportamento
import { prisma } from "../prisma";

/**
 * Mocka o módulo do Prisma.
 * O 'jest.mock' é "hoisted" (elevado) por padrão, então ele roda antes
 * de qualquer 'import'. Quando o 'app' for importado, ele já receberá
 * este mock do Prisma.
 */
jest.mock("../prisma", () => ({
  prisma: {
    user: {
      create: jest.fn(),
      findMany: jest.fn(),
      findUnique: jest.fn(),
      delete: jest.fn(),
    },
    // Mockamos $connect e $disconnect para não fazerem nada
    $connect: jest.fn(),
    $disconnect: jest.fn(),
  },
}));

// Criamos uma referência tipada ao mock para facilitar o uso
// e ter autocomplete no editor.
const prismaMock = prisma as jest.Mocked<typeof prisma>;

describe("API Testes", () => {
  // Limpa o estado dos mocks antes de cada teste
  // Isso garante que um teste não interfira no outro
  beforeEach(() => {
    jest.clearAllMocks();
  });

  // --- Teste de Health Check (Não precisa de DB) ---

  it("GET / - deve responder com o status do serviço", async () => {
    const res = await request(app).get("/");

    expect(res.status).toBe(200);
    expect(res.body).toHaveProperty("service", "api");
  });

  // --- Testes de CRUD /users (com DB Mockado) ---

  describe("CRUD /users", () => {
    it("POST /users - deve criar um novo usuário e retornar 201", async () => {
      // 1. Arrange (Arrumar)
      const mockUser = {
        id: "mock-uuid-123",
        name: "Test",
        email: "test@example.com",
        createdAt: new Date(),
        updatedAt: new Date(),
      };

      // Configura o mock para retornar o usuário criado
      prismaMock.user.create.mockResolvedValue(mockUser);

      // 2. Act (Agir)
      const res = await request(app)
        .post("/user")
        .send({ name: "Test", email: "test@example.com" });

      // 3. Assert (Verificar)
      expect(res.status).toBe(201);
      expect(res.body).toEqual({
        ...mockUser,
        // Converte datas para string, pois o JSON.stringify faz isso
        createdAt: mockUser.createdAt.toISOString(),
        updatedAt: mockUser.updatedAt.toISOString(),
      });
      // Verifica se o controller chamou o prisma com os dados corretos
      expect(prismaMock.user.create).toHaveBeenCalledWith({
        data: { name: "Test", email: "test@example.com" },
      });
    });

    it("GET /users - deve retornar uma lista de usuários", async () => {
      // 1. Arrange
      const mockUsers = [
        { id: "mock-uuid-123", name: "Test 1", email: "test1@example.com" },
        { id: "mock-uuid-456", name: "Test 2", email: "test2@example.com" },
      ];
      prismaMock.user.findMany.mockResolvedValue(mockUsers);

      // 2. Act
      const res = await request(app).get("/user");

      // 3. Assert
      expect(res.status).toBe(200);
      expect(Array.isArray(res.body)).toBe(true);
      expect(res.body).toEqual(mockUsers);
      expect(prismaMock.user.findMany).toHaveBeenCalledTimes(1);
    });

    it("GET /users/:id - deve retornar um usuário específico", async () => {
      // 1. Arrange
      const mockUser = {
        id: "mock-uuid-123",
        name: "Test 1",
        email: "test1@example.com",
      };
      prismaMock.user.findUnique.mockResolvedValue(mockUser);

      // 2. Act
      const res = await request(app).get("/user/mock-uuid-123");

      // 3. Assert
      expect(res.status).toBe(200);
      expect(res.body).toEqual(mockUser);
      expect(prismaMock.user.findUnique).toHaveBeenCalledWith({
        where: { id: "mock-uuid-123" },
      });
    });

    it("DELETE /users/:id - deve deletar um usuário e retornar 204", async () => {
      // 1. Arrange
      // O delete do Prisma retorna o objeto deletado, mas a rota retorna 204 (No Content)
      prismaMock.user.delete.mockResolvedValue({
        id: "mock-uuid-123",
        name: "Test 1",
        email: "test1@example.com",
      });

      // 2. Act
      const res = await request(app).delete("/user/mock-uuid-123");

      // 3. Assert
      expect(res.status).toBe(204);
      expect(res.body).toEqual({}); // Sem conteúdo
      expect(prismaMock.user.delete).toHaveBeenCalledWith({
        where: { id: "mock-uuid-123" },
      });
    });
  });
});
